<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaso Property Management | Unit Assessor v3.2</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        leaso: {
                            blue: '#1E40AF',   /* Deep Trust Blue */
                            gold: '#D4AF37',   /* Quality Gold */
                            light: '#F8F9FA',  /* Background */
                            dark: '#111827',   /* Text */
                            alert: '#DC2626',  /* Red */
                            success: '#059669' /* Green */
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Roboto"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles for Printing and Inputs */
        body {
            background-color: #F3F4F6;
            color: #1F2937;
        }

        /* Form Inputs */
        .leaso-input {
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            padding: 0.75rem;
            width: 100%;
            transition: all 0.2s;
            font-family: 'Roboto', sans-serif;
        }
        .leaso-input:focus {
            border-color: #1E40AF;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
            outline: none;
        }

        /* Checkboxes */
        .leaso-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #9CA3AF;
            border-radius: 0.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .leaso-checkbox:checked {
            background-color: #1E40AF;
            border-color: #1E40AF;
        }
        .leaso-checkbox:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 0.75rem;
        }

        /* Critical Checkbox variant */
        .leaso-checkbox.critical:checked {
            background-color: #DC2626;
            border-color: #DC2626;
        }

        /* Card Styling */
        .leaso-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-top: 4px solid #1E40AF;
        }

        /* === ARCHIE CORE FIX: STRUCTURAL PRINT OVERRIDES === */
        @media print {
            /* 1. Reset Body: Remove background colors and ensure full flow */
            body {
                background: white !important;
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 2. Hide UI Elements: Completely remove non-report elements from layout */
            header, 
            main, 
            footer, 
            .no-print, 
            button,
            #statusIndicator,
            #appSwitcherMenu {
                display: none !important;
            }

            /* 3. Un-Fix the Modal: Force it to behave like a static document */
            #reportModal {
                display: block !important;
                position: relative !important; /* Overrides 'fixed' */
                inset: auto !important;
                width: 100% !important;
                height: auto !important; /* Allows expansion across pages */
                overflow: visible !important; /* Prevents scrollbars/clipping */
                background: white !important;
                z-index: auto !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 4. Adjust Internal Containers */
            #reportModal > div {
                min-height: 0 !important;
                display: block !important;
                padding: 0 !important;
            }

            #reportModal .bg-white {
                box-shadow: none !important;
                max-width: none !important;
                width: 100% !important;
                border-radius: 0 !important;
            }

            /* 5. Printable Content Area */
            #printableContent {
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
            }

            /* 6. Page Break Management */
            .print-break {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            h2, h3 {
                page-break-after: avoid;
            }

            img {
                page-break-inside: avoid;
                max-width: 100% !important;
            }
            
            /* 7. Color Fidelity */
            .bg-gray-50 {
                background-color: #f9fafb !important; /* Slight grey for contrast */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .text-leaso-blue { color: #1E40AF !important; }
            .text-leaso-gold { color: #D4AF37 !important; }
        }
        
        /* Modal overlay styles (Normal Screen) */
        #reportModal {
            display: none;
        }
        
        #reportModal:not(.hidden) {
            display: block;
        }

        /* App Switcher */
        #appSwitcherMenu { transition: transform 0.2s ease-out, opacity 0.2s; transform-origin: top right; }
        #appSwitcherMenu.hidden { transform: scale(0.95); opacity: 0; pointer-events: none; }
        #appSwitcherMenu.block { transform: scale(1); opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- === HEADER === -->
    <header class="bg-white border-b border-leaso-gold shadow-sm sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 py-3 flex justify-between items-center relative">
            <div class="flex items-center space-x-3">
                <a href="index.html" class="text-gray-400 hover:text-leaso-blue transition mr-2 no-print"><i class="fas fa-th text-lg"></i></a>
                <img src="https://img1.wsimg.com/isteam/ip/0bfec085-3f40-401f-834e-86515cf3fc7f/Leaso-799e647.png/:/rs=w:535,h:227,cg:true,m/cr=w:535,h:227/qt=q:100/ll" 
                     alt="Leaso Property Management" 
                     class="h-10 w-auto">
                <span class="text-[10px] uppercase tracking-widest text-gray-400 font-sans border-l border-gray-300 pl-3 ml-3 hidden sm:inline">Unit Assessor v3.2</span>
            </div>
            
            <div class="flex items-center space-x-4">
                <div id="statusIndicator" class="hidden md:block text-xs uppercase tracking-wider font-bold bg-leaso-blue px-3 py-1 rounded text-white shadow">
                    System Ready
                </div>
                <!-- App Switcher Button (No Print) -->
                <button onclick="toggleAppSwitcher()" class="h-8 w-8 rounded-full bg-gray-100 text-leaso-dark hover:bg-leaso-gold hover:text-white flex items-center justify-center transition shadow-sm no-print">
                    <i class="fas fa-folder text-xs"></i>
                </button>
                
                <!-- App Switcher Menu -->
                <div id="appSwitcherMenu" class="hidden absolute top-12 right-6 bg-white rounded-lg shadow-xl border border-gray-100 w-48 py-2 z-50 no-print">
                    <p class="px-4 py-2 text-[10px] font-bold text-gray-400 uppercase border-b border-gray-100">Switch Application</p>
                    <a href="runner-app.html" class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-map-location-dot text-leaso-blue"></i> Runner Command
                    </a>
                    <a href="dispatcher-app.html" class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                        <i class="fas fa-satellite-dish text-leaso-dark"></i> Admin Dispatch
                    </a>
                    <a href="index.html" class="block px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-t border-gray-100">
                        <i class="fas fa-th text-leaso-gold"></i> Portal Home
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- === MAIN CONTENT === -->
    <main class="flex-grow max-w-5xl mx-auto w-full p-4 md:p-8 space-y-6">

        <!-- INTRO CARD -->
        <section class="leaso-card p-6">
            <div class="flex justify-between items-end border-b border-gray-200 pb-4 mb-4">
                <h2 class="font-serif text-2xl text-leaso-blue font-bold">Inspection Context</h2>
                <button onclick="resetForm()" class="text-xs text-gray-400 hover:text-red-500 underline no-print">Reset Form</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Address -->
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Property Address</label>
                    <input type="text" id="propAddress" class="leaso-input font-medium" placeholder="Start typing address..." list="propertyList">
                    <datalist id="propertyList"></datalist>
                </div>

                <!-- Core Details -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tenant Name (Ref)</label>
                    <input type="text" id="tenantName" class="leaso-input" placeholder="Last Name / File #">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Assessor Name</label>
                    <input type="text" id="assessorName" class="leaso-input" placeholder="Field Agent Name">
                </div>

                <!-- Dynamic Type Selector -->
                <div class="col-span-1 md:col-span-2 bg-blue-50 p-4 rounded border border-blue-100">
                    <label class="block text-xs font-bold text-leaso-blue uppercase mb-2">Inspection Type (Configures Checklist)</label>
                    <select id="inspectionType" class="leaso-input border-leaso-blue text-leaso-blue font-bold cursor-pointer" onchange="updateChecklistMode()">
                        <option value="routine">Routine / Periodic Inspection (RTA Focus)</option>
                        <option value="moveIn">Move-In Condition (Baseline)</option>
                        <option value="moveOut">Move-Out (Damage vs. Wear & Tear)</option>
                        <option value="rentReady">Renovation / Turnover (Rent-Ready)</option>
                    </select>
                    <p id="typeDescription" class="text-xs text-gray-500 mt-2 italic">Focus: Lease violations, safety compliance, and unauthorized occupants.</p>
                </div>
            </div>
        </section>

        <!-- COMPLIANCE SHIELD -->
        <section class="leaso-card p-6 border-t-4 !border-t-leaso-gold">
            <h2 class="font-serif text-xl text-gray-800 font-bold mb-4 flex items-center">
                <i class="fas fa-shield-alt text-leaso-gold mr-3"></i> Regulatory Compliance Shield
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- RTA Entry -->
                <label class="flex items-start space-x-3 p-3 bg-gray-50 rounded border hover:bg-white transition cursor-pointer">
                    <input type="checkbox" id="complianceRTA" class="leaso-checkbox mt-1">
                    <div>
                        <span class="block text-sm font-bold text-gray-700">RTA Entry Protocol (s. 27)</span>
                        <span class="text-xs text-gray-500">24-hour written notice served or emergency/consent verified.</span>
                    </div>
                </label>
                <!-- OHRA -->
                <label class="flex items-start space-x-3 p-3 bg-gray-50 rounded border hover:bg-white transition cursor-pointer">
                    <input type="checkbox" id="complianceOHRA" class="leaso-checkbox mt-1">
                    <div>
                        <span class="block text-sm font-bold text-gray-700">OHRA Accessibility Check</span>
                        <span class="text-xs text-gray-500">Entrance/egress is barrier-free or accommodation documented.</span>
                    </div>
                </label>
                <!-- Fire Code -->
                <label class="flex items-start space-x-3 p-3 bg-red-50 rounded border border-red-100 hover:bg-white transition cursor-pointer">
                    <input type="checkbox" id="complianceFire" class="leaso-checkbox critical mt-1">
                    <div>
                        <span class="block text-sm font-bold text-red-700">Vital Service: Smoke/CO Alarms</span>
                        <span class="text-xs text-red-600">Tested and functional on all sleeping levels.</span>
                    </div>
                </label>
                <!-- HVAC -->
                <label class="flex items-start space-x-3 p-3 bg-red-50 rounded border border-red-100 hover:bg-white transition cursor-pointer">
                    <input type="checkbox" id="complianceHeat" class="leaso-checkbox critical mt-1">
                    <div>
                        <span class="block text-sm font-bold text-red-700">Vital Service: Heat/Water</span>
                        <span class="text-xs text-red-600">Minimum 20Â°C (Sept-June) & Hot water supply active.</span>
                    </div>
                </label>
            </div>
        </section>

        <!-- DYNAMIC CHECKLIST AREA -->
        <div id="dynamicChecklistArea" class="space-y-6">
            <!-- JavaScript will inject specific room cards here based on Inspection Type -->
        </div>

        <!-- PHOTO EVIDENCE LOCKER -->
        <section class="leaso-card p-6">
            <div class="flex justify-between items-center border-b border-gray-200 pb-4 mb-4">
                <h2 class="font-serif text-xl text-leaso-blue font-bold">
                    <i class="fas fa-camera mr-2"></i> Evidence Locker
                </h2>
                <span class="text-xs bg-gray-200 px-2 py-1 rounded font-bold" id="photoCounter">0 / 25</span>
            </div>

            <!-- Upload Zone -->
            <label class="block w-full border-2 border-dashed border-leaso-blue bg-blue-50 rounded-lg p-8 text-center cursor-pointer hover:bg-blue-100 transition mb-6 no-print">
                <i class="fas fa-cloud-upload-alt text-3xl text-leaso-blue mb-2"></i>
                <span class="block text-sm font-bold text-leaso-blue">Tap to Add Photos</span>
                <span class="block text-xs text-gray-500 mt-1">Images auto-compressed for report generation.</span>
                <input type="file" id="photoInput" accept="image/*" multiple class="hidden" onchange="handlePhotoUpload(this)">
            </label>

            <!-- Grid -->
            <div id="photoGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Thumbnails injected here -->
            </div>
        </section>

        <!-- NOTES -->
        <section class="leaso-card p-6">
             <h2 class="font-serif text-xl text-leaso-blue font-bold mb-4">Forensic Summary</h2>
             <textarea id="finalNotes" rows="5" class="leaso-input" placeholder="Provide a professional summary of findings. Note any immediate actions required."></textarea>
        </section>

    </main>

    <!-- === FOOTER === -->
    <footer class="bg-white border-t border-gray-200 p-6 sticky bottom-0 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] no-print">
        <div class="max-w-5xl mx-auto flex gap-4">
            <button onclick="saveDraft()" class="flex-1 py-3 px-4 rounded bg-gray-100 text-gray-600 font-bold text-sm uppercase tracking-wider hover:bg-gray-200 transition">
                Save Draft
            </button>
            <button onclick="generateReport()" class="flex-[2] py-3 px-4 rounded bg-leaso-blue text-white font-bold text-sm uppercase tracking-wider hover:bg-blue-800 transition shadow-lg flex justify-center items-center">
                <span>Compile Official Record</span>
                <i class="fas fa-file-contract ml-2"></i>
            </button>
        </div>
    </footer>

    <!-- === REPORT MODAL (Hidden) === -->
    <div id="reportModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[100] hidden overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white max-w-4xl w-full rounded shadow-2xl overflow-hidden relative">
                
                <!-- Toolbar -->
                <div class="bg-gray-100 p-4 flex justify-between items-center border-b no-print sticky top-0 z-10">
                    <h3 class="font-bold text-gray-700 font-sans uppercase">Report Preview</h3>
                    <div class="space-x-2">
                        <button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-600 font-medium hover:bg-gray-200 rounded">Edit</button>
                        <button onclick="printReport()" class="px-4 py-2 bg-leaso-blue text-white text-sm font-bold rounded hover:bg-blue-800 shadow">
                            <i class="fas fa-print mr-2"></i> Print to PDF
                        </button>
                    </div>
                </div>

                <!-- PRINTABLE CONTENT -->
                <div id="printableContent" class="p-8 md:p-12 print-container">
                    <!-- Letterhead -->
                    <div class="flex justify-between items-start border-b-2 border-leaso-gold pb-6 mb-8">
                        <div>
                            <img src="https://img1.wsimg.com/isteam/ip/0bfec085-3f40-401f-834e-86515cf3fc7f/Leaso-799e647.png/:/rs=w:535,h:227,cg:true,m/cr=w:535,h:227/qt=q:100/ll" 
                                 alt="Leaso Property Management" 
                                 class="h-16 mb-2">
                            <p class="text-xs uppercase tracking-[0.3em] text-gray-500">Property Management Systems</p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-xl font-bold uppercase text-gray-800" id="rptTitle">UNIT ASSESSMENT REPORT</h2>
                            <p class="text-sm text-gray-500 mt-1 font-sans" id="rptDate">Date: ---</p>
                            <p class="text-xs text-gray-400 font-mono" id="rptId">ID: ---</p>
                        </div>
                    </div>

                    <!-- Meta Data Grid -->
                    <div class="bg-gray-50 p-6 rounded border border-gray-200 mb-8 grid grid-cols-2 gap-y-4 gap-x-8 text-sm">
                        <div>
                            <span class="block text-xs font-bold text-gray-400 uppercase">Property Address</span>
                            <span class="block font-bold text-gray-800 text-base" id="rptAddress">---</span>
                        </div>
                        <div>
                            <span class="block text-xs font-bold text-gray-400 uppercase">Inspection Type</span>
                            <span class="block font-bold text-gray-800 text-base" id="rptType">---</span>
                        </div>
                        <div>
                            <span class="block text-xs font-bold text-gray-400 uppercase">Tenant Ref</span>
                            <span class="block text-gray-800" id="rptTenant">---</span>
                        </div>
                        <div>
                            <span class="block text-xs font-bold text-gray-400 uppercase">Assessor</span>
                            <span class="block text-gray-800" id="rptAssessor">---</span>
                        </div>
                    </div>

                    <!-- Compliance Section -->
                    <div class="mb-8">
                        <h3 class="font-serif text-lg font-bold text-leaso-blue border-b border-gray-200 pb-2 mb-4">Regulatory Compliance Audit</h3>
                        <div id="rptCompliance" class="grid grid-cols-2 gap-4">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Main Findings -->
                    <div class="mb-8">
                        <h3 class="font-serif text-lg font-bold text-leaso-blue border-b border-gray-200 pb-2 mb-4">Detailed Findings</h3>
                        <div id="rptFindings" class="space-y-2 text-sm">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-8">
                        <h3 class="font-serif text-lg font-bold text-leaso-blue border-b border-gray-200 pb-2 mb-4">Forensic Summary</h3>
                        <div id="rptNotes" class="bg-gray-50 p-4 rounded border border-gray-200 text-sm italic text-gray-700 whitespace-pre-wrap"></div>
                    </div>

                    <!-- Photo Matrix -->
                    <div class="mb-8 print-break">
                        <h3 class="font-serif text-lg font-bold text-leaso-blue border-b border-gray-200 pb-2 mb-4">Photographic Evidence</h3>
                        <div id="rptPhotoMatrix" class="grid grid-cols-2 gap-4">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="mt-12 pt-6 border-t border-gray-300 text-center">
                        <p class="text-[10px] text-gray-400 uppercase">
                            Generated by Leaso Unit Assessor v3.2 | This document serves as an official internal record.<br>
                            Verified against Ontario Residential Tenancies Act Standards.
                        </p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- === LOGIC ENGINE === -->
    <script>
        // === CONFIGURATION ===
        const CONFIG = {
            maxPhotos: 25,
            photoQuality: 0.7, // JPEG quality
            maxPhotoWidth: 1000 // Resize to this width
        };

        // Checklist Definitions
        const CHECKLIST_MODULES = {
            kitchen: {
                title: "Kitchen & Appliances",
                icon: "fa-utensils",
                items: [
                    { id: "k_sink", label: "Sink / Faucet Pressure / Leaks", type: "condition" },
                    { id: "k_drain", label: "Under-Sink Plumbing (P-Trap)", type: "condition" },
                    { id: "k_stove", label: "Stove/Oven Functionality", type: "condition" },
                    { id: "k_fridge", label: "Fridge/Freezer Cooling", type: "condition" },
                    { id: "k_cabinets", label: "Cabinet Hinges & Drawers", type: "condition" },
                    { id: "k_serial", label: "Appliance Serial Numbers Recorded?", type: "binary" }
                ]
            },
            bath: {
                title: "Bathroom & Plumbing",
                icon: "fa-bath",
                items: [
                    { id: "b_toilet", label: "Toilet Flush / Seal Stability", type: "condition" },
                    { id: "b_shower", label: "Shower/Tub Diverter & Pressure", type: "condition" },
                    { id: "b_caulk", label: "Caulking / Grout Integrity", type: "condition" },
                    { id: "b_fan", label: "Exhaust Fan Function", type: "binary" },
                    { id: "b_mold", label: "Signs of Mold/Mildew?", type: "binary_risk" }
                ]
            },
            systems: {
                title: "Systems, Safety & Utility",
                icon: "fa-plug",
                items: [
                    { id: "s_smoke", label: "Smoke/CO Alarms (Check Expiry)", type: "text_date" },
                    { id: "s_filter", label: "HVAC Filter Condition", type: "condition" },
                    { id: "s_thermo", label: "Thermostat Functionality", type: "binary" },
                    { id: "s_breaker", label: "Breaker Panel Accessible/Labeled?", type: "binary" },
                    { id: "s_windows", label: "Window Locks & Seals", type: "condition" }
                ]
            },
            living: {
                title: "Living Areas & Interior",
                icon: "fa-couch",
                items: [
                    { id: "l_floors", label: "Flooring Condition", type: "condition" },
                    { id: "l_walls", label: "Wall Paint / Drywall Integrity", type: "condition" },
                    { id: "l_doors", label: "Door Hardware / Latches", type: "condition" },
                    { id: "l_lights", label: "Lighting Fixtures / Bulbs", type: "condition" }
                ]
            }
        };

        const PROPERTIES = [
            { address: "2480 Prince Michael Drive", city: "Oakville", units: ["Unit 31"] },
            { address: "116 Deschene Avenue", city: "Hamilton", units: ["Basement", "Unit 2"] },
            { address: "136 Gage Avenue South", city: "Hamilton", units: ["Common Area", "Unit 1 - Front Room", "Unit 1 - Middle Room", "Unit 1 - Back Room (Master)", "Unit 1 - Room 4", "Unit 2 - Basement"] },
            { address: "157 Albert Street East", city: "Sault Ste. Marie", units: ["Garage", "Unit 1", "Unit 2", "Unit 3", "Unit 4", "Unit 5", "Unit 7", "Unit 8"] },
            { address: "311 Huron Street", city: "Sault Ste. Marie", units: ["Garage", "Unit 1", "Unit 2"] }, 
            { address: "535 Mohawk Road West", city: "Hamilton", units: ["Common Area", "Private Room For Rent | Room 4", "R2", "SFH1"] }, 
            { address: "5 Napier St", city: "St. Catharines", units: ["Common Area", "Unit 1", "Unit 2", "Unit 3", "Unit 4", "Unit 5", "Unit 6", "Unit 7", "Unit 9", "Unit 10", "Unit 11"] },
            { address: "30 Grace Street", city: "Sault Ste. Marie", units: ["Studio 1 Bath - House - Unit 3", "Unit 1", "Unit 2"] },
            { address: "12 Main Street East", city: "Selkirk", units: ["Unit 1", "Unit 2", "Unit 3"] },
            { address: "127 Andrew St", city: "Sault Ste. Marie", units: ["Unit 1"] },
            { address: "105 Huron Street", city: "Sault Ste. Marie", units: ["Unit 1", "Unit 2", "Unit 3"] },
            { address: "185 Welland St", city: "Port Colborne", units: ["Unit 1", "Unit 2"] },
            { address: "22 Ferris Ave", city: "Sault Ste. Marie", units: ["Unit 1", "Unit 2 (2nd floor)"] },
            { address: "380 Park St N", city: "Peterborough", units: ["Unit 1", "Unit 2", "Unit 4", "Unit 6", "Unit 7", "Unit 8"] }, 
            { address: "189 March Street", city: "Sault Ste. Marie", units: ["Unit 1 - Lower", "Unit 2 - Upper"] },
            { address: "162 Division St", city: "St. Catharines", units: ["Unit 1 - Room 1", "Unit 1 - Room 2", "Unit 1 - Room 3", "Unit 2 - Front Upper", "Unit 3 - Back Upper", "Unit 4 - Basement"] }, 
            { address: "130 York St", city: "St. Catharines", units: ["Unit 1 (main floor)", "Unit 2 (2nd floor)"] },
            { address: "181 Welland Street", city: "Port Colborne", units: ["Unit 2"] },
            { address: "128 Belanger Avenue", city: "Timmins", units: ["Unit A", "Unit B", "Unit C"] },
            { address: "64 Preston St", city: "Timmins", units: ["Basement", "Unit A - Studio", "Unit C"] },
            { address: "227 Maplewood Ave", city: "Hamilton", units: ["Main (Single Family)"] }
        ];

        // State Management
        let appState = {
            photos: [] // { id, data, caption }
        };

        // === INITIALIZATION ===
        window.onload = function() {
            loadDraft();
            updateChecklistMode();
            initPropList();
            setInterval(saveDraft, 5000); // Auto-save every 5s
        };

        function initPropList() {
            const dl = document.getElementById('propertyList');
            PROPERTIES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = `${p.address}, ${p.city}`;
                dl.appendChild(opt);
            });
        }

        // === LOGIC FUNCTIONS ===

        function updateChecklistMode() {
            const mode = document.getElementById('inspectionType').value;
            const container = document.getElementById('dynamicChecklistArea');
            const desc = document.getElementById('typeDescription');
            
            // Update Description
            const descriptions = {
                routine: "Focus: Lease violations, safety compliance, and unauthorized occupants.",
                moveIn: "Focus: Documenting pre-existing conditions to protect Tenant & Landlord.",
                moveOut: "Focus: Distinguishing between Tenant Damage (L1/L2) and Normal Wear & Tear.",
                rentReady: "Focus: Identifying upgrades and repairs needed for market readiness."
            };
            desc.innerText = descriptions[mode];

            // Render Modules
            container.innerHTML = "";
            
            for (const [key, module] of Object.entries(CHECKLIST_MODULES)) {
                const card = document.createElement('div');
                card.className = "leaso-card p-6";
                
                let html = `
                    <h3 class="font-serif text-lg font-bold text-leaso-blue mb-4 border-b border-gray-100 pb-2">
                        <i class="fas ${module.icon} mr-2 text-leaso-gold"></i> ${module.title}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                module.items.forEach(item => {
                    html += generateInputHTML(item, mode);
                });

                html += `</div>`;
                card.innerHTML = html;
                container.appendChild(card);
            }
            
            // Restore values if existing
            restoreInputValues();
        }

        function generateInputHTML(item, mode) {
            let controlHTML = "";
            const inputId = `${item.id}`;

            // Logic Switch based on Mode & Item Type
            if (mode === 'moveOut' && item.type === 'condition') {
                // Move Out: Specific Damage Toggles
                controlHTML = `
                    <div class="mt-1 flex gap-2">
                        <label class="flex items-center text-xs cursor-pointer"><input type="radio" name="${inputId}" value="Good" class="mr-1"> Good</label>
                        <label class="flex items-center text-xs cursor-pointer text-gray-500"><input type="radio" name="${inputId}" value="Wear" class="mr-1"> Wear/Tear</label>
                        <label class="flex items-center text-xs cursor-pointer text-red-600 font-bold"><input type="radio" name="${inputId}" value="Damage" class="mr-1"> DAMAGE</label>
                    </div>
                `;
            } else if (mode === 'rentReady' && item.type === 'condition') {
                // Rent Ready: Upgrade/Repair
                controlHTML = `
                      <div class="mt-1 flex gap-2">
                        <label class="flex items-center text-xs cursor-pointer"><input type="radio" name="${inputId}" value="Ready" class="mr-1"> Ready</label>
                        <label class="flex items-center text-xs cursor-pointer text-leaso-blue"><input type="radio" name="${inputId}" value="Clean" class="mr-1"> Needs Clean</label>
                        <label class="flex items-center text-xs cursor-pointer text-leaso-gold font-bold"><input type="radio" name="${inputId}" value="Repair" class="mr-1"> REPAIR</label>
                    </div>
                `;
            } else if (item.type === 'binary_risk') {
                 controlHTML = `
                      <div class="mt-1 flex gap-2">
                        <label class="flex items-center text-xs cursor-pointer"><input type="radio" name="${inputId}" value="No" class="mr-1" checked> No</label>
                        <label class="flex items-center text-xs cursor-pointer text-red-600 font-bold"><input type="radio" name="${inputId}" value="YES" class="mr-1"> YES (Risk)</label>
                    </div>
                `;
            } else if (item.type === 'text_date') {
                 controlHTML = `
                    <input type="text" id="${inputId}" class="leaso-input text-sm py-1 px-2 mt-1" placeholder="e.g., Expiry 2029 or Serial #">
                 `;
            } else {
                // Default / Routine
                controlHTML = `
                    <select id="${inputId}" class="leaso-input text-sm py-1 mt-1">
                        <option value="">Select Status...</option>
                        <option value="Good">Good / Functional</option>
                        <option value="Fair">Fair / Cosmetic Issue</option>
                        <option value="Poor">Poor / Action Req</option>
                        <option value="N/A">N/A</option>
                    </select>
                `;
            }

            return `
                <div class="bg-gray-50 p-3 rounded border border-gray-100 hover:border-blue-200 transition group">
                    <label class="block text-xs font-bold text-gray-600 group-hover:text-leaso-blue">${item.label}</label>
                    ${controlHTML}
                </div>
            `;
        }

        // === PHOTO HANDLING (COMPRESSION) ===
        function handlePhotoUpload(input) {
            const files = Array.from(input.files);
            
            if (appState.photos.length + files.length > CONFIG.maxPhotos) {
                alert(`Limit reached. Maximum ${CONFIG.maxPhotos} photos allowed.`);
                return;
            }

            document.getElementById('photoCounter').innerText = "Processing...";

            let processedCount = 0;

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Canvas Compression Logic
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > CONFIG.maxPhotoWidth) {
                            height *= CONFIG.maxPhotoWidth / width;
                            width = CONFIG.maxPhotoWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const compressedData = canvas.toDataURL('image/jpeg', CONFIG.photoQuality);
                        
                        appState.photos.push({
                            id: Date.now() + Math.random(),
                            data: compressedData,
                            caption: ""
                        });

                        processedCount++;
                        if (processedCount === files.length) {
                            renderPhotoGrid();
                            saveDraft();
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            input.value = ""; // Reset input
        }

        function renderPhotoGrid() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = "";
            document.getElementById('photoCounter').innerText = `${appState.photos.length} / ${CONFIG.maxPhotos}`;

            appState.photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = "bg-white p-2 rounded shadow border border-gray-200 relative group";
                div.innerHTML = `
                    <img src="${photo.data}" class="w-full h-32 object-cover rounded mb-2">
                    <input type="text" 
                        onchange="updateCaption(${index}, this.value)" 
                        value="${photo.caption}" 
                        placeholder="Add caption..." 
                        class="w-full text-xs border-b border-gray-200 focus:border-leaso-blue outline-none py-1">
                    <button onclick="removePhoto(${index})" class="absolute top-1 right-1 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center shadow hover:bg-red-700 opacity-90">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `;
                grid.appendChild(div);
            });
        }

        function removePhoto(index) {
            appState.photos.splice(index, 1);
            renderPhotoGrid();
            saveDraft();
        }

        function updateCaption(index, val) {
            appState.photos[index].caption = val;
            saveDraft();
        }

        // === PERSISTENCE ===
        function saveDraft() {
            // Save inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            let inputData = {};
            inputs.forEach(el => {
                if (el.type === 'radio' || el.type === 'checkbox') {
                    if (el.checked) inputData[el.id || el.name] = el.value;
                } else {
                    inputData[el.id] = el.value;
                }
            });

            const dataToSave = {
                inputs: inputData,
                photos: appState.photos
            };

            localStorage.setItem('leaso_v3_draft', JSON.stringify(dataToSave));
            
            // UI Feedback
            const btn = document.querySelector('button[onclick="saveDraft()"]');
            const originalText = btn.innerText;
            btn.innerText = "Saved!";
            setTimeout(() => btn.innerText = originalText, 1000);
        }

        function loadDraft() {
            const stored = localStorage.getItem('leaso_v3_draft');
            if (!stored) return;

            const data = JSON.parse(stored);
            
            // Restore Photos
            if (data.photos) {
                appState.photos = data.photos;
                renderPhotoGrid();
            }

            // Restore Inputs (Need to wait for dynamic render for some)
            // We store this data in a global var to be accessed by restoreInputValues
            window.savedInputData = data.inputs;
        }

        function restoreInputValues() {
            if (!window.savedInputData) return;
            const data = window.savedInputData;

            for (const [key, value] of Object.entries(data)) {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') el.checked = true;
                    else el.value = value;
                } else {
                    // Try radio buttons
                    const radios = document.getElementsByName(key);
                    if (radios.length > 0) {
                        radios.forEach(r => {
                            if (r.value === value) r.checked = true;
                        });
                    }
                }
            }
        }

        function resetForm() {
            if (confirm("Reset Form? This will clear all data and photos.")) {
                localStorage.removeItem('leaso_v3_draft');
                location.reload();
            }
        }

        // === REPORT GENERATION ===
        function generateReport() {
            saveDraft(); // Ensure current state is captured
            
            // 1. Header Data
            document.getElementById('rptDate').innerText = "Date: " + new Date().toLocaleDateString();
            document.getElementById('rptId').innerText = "ID: " + Math.floor(Math.random() * 100000);
            document.getElementById('rptAddress').innerText = document.getElementById('propAddress').value || "N/A";
            document.getElementById('rptTenant').innerText = document.getElementById('tenantName').value || "N/A";
            document.getElementById('rptAssessor').innerText = document.getElementById('assessorName').value || "N/A";
            
            // Get Readable Type
            const typeSelect = document.getElementById('inspectionType');
            document.getElementById('rptType').innerText = typeSelect.options[typeSelect.selectedIndex].text;

            // 2. Compliance
            const complianceDiv = document.getElementById('rptCompliance');
            complianceDiv.innerHTML = "";
            const comps = [
                { id: 'complianceRTA', label: "RTA Entry Protocol (24h Notice)" },
                { id: 'complianceOHRA', label: "OHRA Accessibility Check" },
                { id: 'complianceFire', label: "Fire Code (Smoke Alarms)" },
                { id: 'complianceHeat', label: "Vital Services (Heat/Water)" }
            ];
            comps.forEach(c => {
                const checked = document.getElementById(c.id).checked;
                const color = checked ? "text-green-700 bg-green-50" : "text-red-700 bg-red-50";
                const icon = checked ? "fa-check-circle" : "fa-times-circle";
                complianceDiv.innerHTML += `
                    <div class="p-2 rounded border border-gray-200 flex items-center ${color}">
                        <i class="fas ${icon} mr-2"></i> <span class="text-xs font-bold uppercase">${c.label}</span>
                    </div>
                `;
            });

            // 3. Findings (Iterate Modules)
            const findingsDiv = document.getElementById('rptFindings');
            findingsDiv.innerHTML = "";
            
            // We loop through the checklist inputs generated
            const inputs = document.querySelectorAll('#dynamicChecklistArea input:checked, #dynamicChecklistArea select, #dynamicChecklistArea input[type="text"]');
            
            inputs.forEach(input => {
                let label = "";
                let value = input.value;
                let isIssue = false;

                // Find label
                // Traverse up to find the label in the container
                const container = input.closest('.group');
                if (container) {
                    label = container.querySelector('label').innerText;
                }

                if (value && value !== "N/A" && value !== "") {
                    // Determine if it's an issue based on keywords
                    if (["Poor", "Damage", "Repair", "YES", "Wear"].includes(value)) isIssue = true;
                    
                    const colorClass = isIssue ? "text-red-600 font-bold" : "text-gray-700";
                    const row = `
                        <div class="flex justify-between border-b border-dotted border-gray-300 pb-1">
                            <span class="text-gray-600">${label}</span>
                            <span class="${colorClass}">${value}</span>
                        </div>
                    `;
                    findingsDiv.innerHTML += row;
                }
            });

            if (findingsDiv.innerHTML === "") findingsDiv.innerHTML = "<p class='text-gray-500 italic'>No specific findings recorded.</p>";

            // 4. Notes
            document.getElementById('rptNotes').innerText = document.getElementById('finalNotes').value || "No additional notes.";

            // 5. Photos
            const photoMatrix = document.getElementById('rptPhotoMatrix');
            photoMatrix.innerHTML = "";
            appState.photos.forEach(photo => {
                photoMatrix.innerHTML += `
                    <div class="border border-gray-200 rounded p-2">
                        <img src="${photo.data}" class="w-full h-48 object-cover rounded mb-2">
                        <p class="text-[10px] font-sans font-bold text-gray-600">${photo.caption || "Evidence"}</p>
                    </div>
                `;
            });

            // Show modal
            document.getElementById('reportModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeModal() {
            document.getElementById('reportModal').classList.add('hidden');
            document.body.style.overflow = 'auto'; // Re-enable scrolling
        }

        function printReport() {
            window.print();
        }

        window.addEventListener('afterprint', function() {
            console.log('Print completed or cancelled');
        });

        function toggleAppSwitcher() {
            const menu = document.getElementById('appSwitcherMenu');
            if (menu.classList.contains('hidden')) { 
                menu.classList.remove('hidden'); 
                setTimeout(() => menu.classList.add('block'), 10); 
            } else { 
                menu.classList.remove('block'); 
                setTimeout(() => menu.classList.add('hidden'), 200); 
            }
        }

    </script>
</body>
</html>
